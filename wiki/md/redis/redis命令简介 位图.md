---
title: redis命令简介 位图
date: 2020-07-08 13:40:45
categories: redis
index_img: /img/articles/redis.jpg
tags:
	- redis
	- 位图
	- bitmap
---

# 位图

`redis`的位图（`bitmap`）是由多个二进制位组成的数组，数组中的每个二进制位都有与之相对应的偏移量（索引），用户可以通过这些偏移量对位图中指定的一个或者多个二进制位进行操作。



## setbit

**作用**：为位图指定偏移量上的二进制位设置值

**格式**：`setbit bitmap offset value`

**扩展**：

命令在对二进制位进行设置后，将返回二进制位被设置之前的旧值作为结果

如果位图不存在，或者位图当前的大小无法满足用户想要执行的设置操作，则`redis`将对被设置的位图进行扩展，使得位图可以满足用户的设置要求

`redis`对位图的扩展操作，是以字节为单位的，因此扩展后的位图包含的二进制位数量可能比用户要求的稍微多一些

命令只能使用正数偏移量，使用负数作为偏移量将引发一个错误



## getbit

**作用**：获取位图指定偏移量上的二进制位的值

**格式**：`getbit bitmap offset`

**扩展**：

命令也只能接受正数作为偏移量

如果输入的偏移量超过了位图目前拥有的最大偏移量，则命令将返回`0`



## bitcount

**作用**：统计位图中值为`1` 的二进制位数量

**格式**：`bitcount bitmap [start end]`

**扩展**：

默认情况下，命令将对位图中包含的所有字节中的二进制位进行统计

也可以通过可选参数`start`与`end`，使得命令只对指定字节范围内的二进制位进行统计

**注意：可选参数`start`与`end`指定的是字节偏移量，而不是二进制偏移量**

另外，可选参数`start`与`end`的值还可以是负数，即使用负数偏移量



## bitpos

**作用**：在位图中查找第一个被设置为指定值的二进制位，并返回这个二进制位的偏移量

**格式**：`bitpos bitmap value [start end]`

**扩展**：

默认情况下，命令将对位图中包含的所有字节中的二进制位进行查找

也可以通过可选参数`start`与`end`，使得命令只对指定字节范围内的二进制位进行查找

**注意：可选参数`start`与`end`指定的是字节偏移量，而不是二进制偏移量**

另外，可选参数`start`与`end`的值还可以是负数，即使用负数偏移量

当用户尝试对一个不存在的位图，或者一个所有位都被设置为`0` 的位图，查找值为`1`的二进制位时，命令将返回`-1`作为结果



## bitop

**作用**：对一个或者多个位图执行指定的二进制位运算，并将运算结果存储到指定的键中

**格式**：`bitop operation result_key bitmap [bitmap ...]`

**扩展**：

参数`operation`可以的取值分别为`AND,OR,XOR,NOT`，分别为逻辑与，逻辑或，逻辑异或，逻辑非

`NOT`运算符只允许使用一个位图作为输入，其他的运算符允许使用任意数量的位图作为输入

命令将计算结果存储到指定的键中之后，将会返回被存储位图的字节长度

当命令对两个长度不相同的位图执行运算时，会将长度较短的那个位图中不存在的二进制位的值看作`0`，即高位补零



## bitfield

**作用**：在位图中的任意区域（`field`）存储指定长度的整数值，并对这些整数值执行加法或者减法操作

**格式**：

`bitfield bitmap set type offset value`

`bitfield bitmap get type offset`

`bitfield bitmap incrby type offset increment`

`bitfiled bitmap [...] overflow WRAP|SAT|FAIL [...]`